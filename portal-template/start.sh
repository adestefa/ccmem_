#!/bin/bash

# CCMem Portal Start Script
# Auto-generated by install-portal.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/config.json"
PID_FILE="$SCRIPT_DIR/portal.pid"

echo "ğŸš€ Starting CCMem Portal..."
echo "ğŸ“ Portal Directory: $SCRIPT_DIR"

# Check if config exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ Error: config.json not found"
    echo "ğŸ’¡ Run install-portal.sh to set up this portal"
    exit 1
fi

# Extract project info from config
PROJECT_NAME=$(node -p "JSON.parse(require('fs').readFileSync('$CONFIG_FILE', 'utf8')).project.name")
PROJECT_DISPLAY_NAME=$(node -p "JSON.parse(require('fs').readFileSync('$CONFIG_FILE', 'utf8')).project.displayName")
SERVER_PORT=$(node -p "JSON.parse(require('fs').readFileSync('$CONFIG_FILE', 'utf8')).server.port")
BASE_PATH=$(node -p "JSON.parse(require('fs').readFileSync('$CONFIG_FILE', 'utf8')).server.basePath")

echo "ğŸ¯ Project: $PROJECT_DISPLAY_NAME ($PROJECT_NAME)"
echo "ğŸ”Œ Port: $SERVER_PORT"
echo "ğŸŒ Path: $BASE_PATH"

# Check if already running
if [ -f "$PID_FILE" ]; then
    OLD_PID=$(cat "$PID_FILE")
    if kill -0 "$OLD_PID" 2>/dev/null; then
        echo "âš ï¸  Portal already running (PID: $OLD_PID)"
        echo "ğŸŒ Dashboard: http://localhost:$SERVER_PORT$BASE_PATH"
        exit 0
    else
        echo "ğŸ§¹ Cleaning up stale PID file"
        rm -f "$PID_FILE"
    fi
fi

# Check for port conflicts
if lsof -i :$SERVER_PORT >/dev/null 2>&1; then
    echo "âŒ Error: Port $SERVER_PORT is already in use"
    echo "ğŸ’¡ Run ./stop.sh first or choose a different port in config.json"
    exit 1
fi

# Start the server
echo "â–¶ï¸  Starting portal server..."
cd "$SCRIPT_DIR"

# Start server in background and capture PID
node server.js &
SERVER_PID=$!

# Save PID for stop script
echo $SERVER_PID > "$PID_FILE"

# Wait a moment and check if server started successfully
sleep 2
if kill -0 "$SERVER_PID" 2>/dev/null; then
    echo "âœ… CCMem Portal started successfully!"
    echo "ğŸ†” Process ID: $SERVER_PID"
    echo "ğŸŒ Dashboard: http://localhost:$SERVER_PORT$BASE_PATH"
    echo "ğŸ“Š Health Check: http://localhost:$SERVER_PORT$BASE_PATH/api/health"
    echo ""
    echo "ğŸ“ To stop the portal:"
    echo "   ./stop.sh"
    echo ""
    echo "ğŸ“‹ To view logs:"
    echo "   tail -f portal.log"
else
    echo "âŒ Failed to start portal server"
    rm -f "$PID_FILE"
    exit 1
fi